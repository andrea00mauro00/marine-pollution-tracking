FROM flink:1.17-scala_2.12

# Installa Python e pip
RUN apt-get update && apt-get install -y python3 python3-pip

# Installa PyFlink senza pemja e altre dipendenze necessarie
RUN pip3 install --no-deps apache-flink==1.17.0 \
    py4j==0.10.9.7 \
    cloudpickle==2.2.0 \
    numpy==1.24.3 \
    pyarrow==8.0.0 \
    pandas==1.5.3 \
    boto3 \
    redis \
    kafka-python \
    gprc

# Configura il percorso Python per trovare le librerie Flink
ENV PYTHONPATH=/opt/flink/opt/python:$PYTHONPATH

# Imposta la directory di lavoro
WORKDIR /opt

# Copia i file del progetto
COPY pollution_detection_job.py /opt/main.py
COPY data_templates.py /opt/data_templates.py

# Copia i JAR necessari
COPY flink-connector-kafka-1.17.0.jar /opt/flink/lib/
COPY kafka-clients-3.3.2.jar /opt/flink/lib/

# Esegui il file Python
CMD ["python3", "/opt/main.py"]